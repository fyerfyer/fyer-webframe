"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[481],{6270:(r,e,n)=>{n.r(e),n.d(e,{assets:()=>l,contentTitle:()=>a,default:()=>g,frontMatter:()=>t,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"web/session/sess","title":"Session","description":"WebFrame \u6846\u67b6\u63d0\u4f9b\u4e86\u5b8c\u5907\u7684\u4f1a\u8bdd\u7ba1\u7406\u7cfb\u7edf\uff0c\u652f\u6301\u591a\u79cd\u5b58\u50a8\u540e\u7aef\u548c\u4f1a\u8bdd\u4f20\u64ad\u65b9\u5f0f\u3002","source":"@site/docs/web/session/sess.md","sourceDirName":"web/session","slug":"/web/session/sess","permalink":"/fyer-webframe/docs/web/session/sess","draft":false,"unlisted":false,"editUrl":"https://github.com/fyerfyer/fyer-webframe/tree/main/docs/web/session/sess.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Server","permalink":"/fyer-webframe/docs/web/server/serve"},"next":{"title":"\u6a21\u677f\u5f15\u64ce","permalink":"/fyer-webframe/docs/web/template/tpl"}}');var s=n(4848),o=n(8453);const t={},a="Session",l={},c=[{value:"\u4f1a\u8bdd\u57fa\u7840",id:"\u4f1a\u8bdd\u57fa\u7840",level:2},{value:"\u4f1a\u8bdd\u7ba1\u7406\u67b6\u6784",id:"\u4f1a\u8bdd\u7ba1\u7406\u67b6\u6784",level:3},{value:"\u6838\u5fc3\u63a5\u53e3",id:"\u6838\u5fc3\u63a5\u53e3",level:3},{value:"\u4f1a\u8bdd\u7ba1\u7406\u5668",id:"\u4f1a\u8bdd\u7ba1\u7406\u5668",level:3},{value:"\u4f1a\u8bdd\u4e2d\u95f4\u4ef6",id:"\u4f1a\u8bdd\u4e2d\u95f4\u4ef6",level:3},{value:"Cookie \u4f1a\u8bdd",id:"cookie-\u4f1a\u8bdd",level:2},{value:"CookiePropagator \u57fa\u672c\u7528\u6cd5",id:"cookiepropagator-\u57fa\u672c\u7528\u6cd5",level:3},{value:"\u914d\u7f6e\u9009\u9879",id:"\u914d\u7f6e\u9009\u9879",level:3},{value:"\u5b89\u5168\u6700\u4f73\u5b9e\u8df5",id:"\u5b89\u5168\u6700\u4f73\u5b9e\u8df5",level:3},{value:"Redis \u4f1a\u8bdd\u5b58\u50a8",id:"redis-\u4f1a\u8bdd\u5b58\u50a8",level:2},{value:"Redis \u4f1a\u8bdd\u5b58\u50a8\u8bbe\u7f6e",id:"redis-\u4f1a\u8bdd\u5b58\u50a8\u8bbe\u7f6e",level:3},{value:"Redis \u4f1a\u8bdd\u5b58\u50a8\u914d\u7f6e",id:"redis-\u4f1a\u8bdd\u5b58\u50a8\u914d\u7f6e",level:3},{value:"Redis \u4f1a\u8bdd\u5b58\u50a8\u7279\u6027",id:"redis-\u4f1a\u8bdd\u5b58\u50a8\u7279\u6027",level:3},{value:"\u5b8c\u6574\u793a\u4f8b",id:"\u5b8c\u6574\u793a\u4f8b",level:2}];function d(r){const e={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...r.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.header,{children:(0,s.jsx)(e.h1,{id:"session",children:"Session"})}),"\n",(0,s.jsx)(e.p,{children:"WebFrame \u6846\u67b6\u63d0\u4f9b\u4e86\u5b8c\u5907\u7684\u4f1a\u8bdd\u7ba1\u7406\u7cfb\u7edf\uff0c\u652f\u6301\u591a\u79cd\u5b58\u50a8\u540e\u7aef\u548c\u4f1a\u8bdd\u4f20\u64ad\u65b9\u5f0f\u3002"}),"\n",(0,s.jsx)(e.h2,{id:"\u4f1a\u8bdd\u57fa\u7840",children:"\u4f1a\u8bdd\u57fa\u7840"}),"\n",(0,s.jsx)(e.h3,{id:"\u4f1a\u8bdd\u7ba1\u7406\u67b6\u6784",children:"\u4f1a\u8bdd\u7ba1\u7406\u67b6\u6784"}),"\n",(0,s.jsx)(e.p,{children:"WebFrame \u7684\u4f1a\u8bdd\u7ba1\u7406\u7cfb\u7edf\u91c7\u7528\u6a21\u5757\u5316\u8bbe\u8ba1\uff0c\u7531\u4e09\u4e2a\u6838\u5fc3\u7ec4\u4ef6\u7ec4\u6210\uff1a"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"Session"}),"\uff1a\u8868\u793a\u5355\u4e2a\u4f1a\u8bdd\uff0c\u8d1f\u8d23\u5177\u4f53\u6570\u636e\u7684\u5b58\u53d6\u64cd\u4f5c"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"Storage"}),"\uff1a\u8d1f\u8d23\u4f1a\u8bdd\u7684\u751f\u547d\u5468\u671f\u7ba1\u7406\uff08\u521b\u5efa\u3001\u67e5\u627e\u3001\u5237\u65b0\u548c\u5220\u9664\uff09"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"Propagator"}),"\uff1a\u8d1f\u8d23\u4f1a\u8bdd ID \u5728\u8bf7\u6c42\u548c\u54cd\u5e94\u4e4b\u95f4\u7684\u4f20\u9012"]}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:"\u8fd9\u79cd\u8bbe\u8ba1\u4f7f\u5f97\u4f1a\u8bdd\u7ba1\u7406\u7cfb\u7edf\u5177\u6709\u5f88\u9ad8\u7684\u7075\u6d3b\u6027\u548c\u53ef\u6269\u5c55\u6027\uff0c\u53ef\u4ee5\u65b9\u4fbf\u5730\u66ff\u6362\u6216\u81ea\u5b9a\u4e49\u5404\u4e2a\u7ec4\u4ef6\u3002"}),"\n",(0,s.jsx)(e.h3,{id:"\u6838\u5fc3\u63a5\u53e3",children:"\u6838\u5fc3\u63a5\u53e3"}),"\n",(0,s.jsx)(e.p,{children:"\u4f1a\u8bdd\u7ba1\u7406\u7684\u6838\u5fc3\u63a5\u53e3\u5b9a\u4e49\u5982\u4e0b\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:"// Session \u8d1f\u8d23\u4f1a\u8bdd\u5177\u4f53\u6570\u636e\u7684\u64cd\u4f5c\r\ntype Session interface {\r\n    Get(ctx context.Context, key string) (any, error)\r\n    Set(ctx context.Context, key string, value any) error\r\n    ID() string\r\n    Touch(ctx context.Context) error\r\n}\r\n\r\n// Storage \u8d1f\u8d23\u4f1a\u8bdd\u7684\u751f\u547d\u5468\u671f\u7ba1\u7406\r\ntype Storage interface {\r\n    Create(ctx context.Context, id string) (Session, error)\r\n    Refresh(ctx context.Context, id string) error\r\n    Find(ctx context.Context, id string) (Session, error)\r\n    Delete(ctx context.Context, id string) error\r\n    GC(ctx context.Context) error\r\n    Close() error\r\n}\r\n\r\n// Propagator \u8d1f\u8d23\u4f1a\u8bddID\u5728\u8bf7\u6c42\u548c\u54cd\u5e94\u4e2d\u7684\u4f20\u9012\r\ntype Propagator interface {\r\n    Insert(id string, resp http.ResponseWriter) error\r\n    Extract(req *http.Request) (string, error)\r\n    Remove(resp http.ResponseWriter) error\r\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u4f1a\u8bdd\u7ba1\u7406\u5668",children:"\u4f1a\u8bdd\u7ba1\u7406\u5668"}),"\n",(0,s.jsx)(e.p,{children:"\u4f1a\u8bdd\u7ba1\u7406\u5668\uff08Manager\uff09\u6574\u5408\u4e86 Storage \u548c Propagator\uff0c\u4e3a\u5e94\u7528\u7a0b\u5e8f\u63d0\u4f9b\u4e86\u4fbf\u4e8e\u4f7f\u7528\u7684\u4f1a\u8bdd\u7ba1\u7406\u65b9\u6cd5\u8c03\u7528\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:"type Manager struct {\r\n    Storage\r\n    Propagator\r\n    sessionKey string\r\n}\r\n\r\nfunc NewMagager(storage Storage, propagator Propagator, sessionKey string) *Manager {\r\n    return &Manager{\r\n        Storage:    storage,\r\n        Propagator: propagator,\r\n        sessionKey: sessionKey,\r\n    }\r\n}\n"})}),"\n",(0,s.jsx)(e.p,{children:"\u4f1a\u8bdd\u7ba1\u7406\u5668\u63d0\u4f9b\u4e86\u4ee5\u4e0b\u4e3b\u8981\u65b9\u6cd5\uff1a"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"InitSession"}),"\uff1a\u521d\u59cb\u5316\u4e00\u4e2a\u65b0\u4f1a\u8bdd\u5e76\u5c06\u5176\u6ce8\u5165\u5230\u8bf7\u6c42\u4e0a\u4e0b\u6587\u4e2d"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"GetSession"}),"\uff1a\u4ece\u8bf7\u6c42\u4e0a\u4e0b\u6587\u6216\u4f20\u64ad\u5668\u4e2d\u83b7\u53d6\u4f1a\u8bdd"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"RefreshSession"}),"\uff1a\u5237\u65b0\u4f1a\u8bdd\u7684\u8fc7\u671f\u65f6\u95f4"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"TouchSession"}),"\uff1a\u66f4\u65b0\u4f1a\u8bdd\u8fc7\u671f\u65f6\u95f4\u4f46\u4e0d\u6539\u53d8\u5176\u6570\u636e"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"DeleteSession"}),"\uff1a\u5220\u9664\u4f1a\u8bdd"]}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"\u4f1a\u8bdd\u4e2d\u95f4\u4ef6",children:"\u4f1a\u8bdd\u4e2d\u95f4\u4ef6"}),"\n",(0,s.jsx)(e.p,{children:"WebFrame \u63d0\u4f9b\u4e86\u4f1a\u8bdd\u4e2d\u95f4\u4ef6\uff0c\u7528\u4e8e\u81ea\u52a8\u5904\u7406\u8bf7\u6c42\u4e2d\u7684\u4f1a\u8bdd\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:"// Middleware \u7528\u4e8e\u521d\u59cb\u5316\u548c\u5904\u7406\u4f1a\u8bdd\u7684\u4e2d\u95f4\u4ef6\r\ntype Middleware struct {\r\n    SessionManager *session.Manager\r\n    AutoCreate     bool\r\n    Initializer    SessionInitializer\r\n}\r\n\r\n// SessionInitializer \u521d\u59cb\u5316\u6700\u521d\u7684\u4f1a\u8bdd\u503c\r\ntype SessionInitializer func(s session.Session) error\n"})}),"\n",(0,s.jsx)(e.p,{children:"\u4f1a\u8bdd\u4e2d\u95f4\u4ef6\u53ef\u4ee5\u914d\u7f6e\u4e3a\uff1a"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u81ea\u52a8\u521b\u5efa\u65b0\u4f1a\u8bdd\uff08\u5f53\u8bf7\u6c42\u6ca1\u6709\u4f1a\u8bdd\u65f6\uff09"}),"\n",(0,s.jsx)(e.li,{children:"\u4f7f\u7528\u81ea\u5b9a\u4e49\u7684\u4f1a\u8bdd\u521d\u59cb\u5316\u5668\u6765\u8bbe\u7f6e\u4f1a\u8bdd\u7684\u521d\u59cb\u6570\u636e"}),"\n",(0,s.jsx)(e.li,{children:"\u81ea\u52a8\u5237\u65b0\u4f1a\u8bdd\u8fc7\u671f\u65f6\u95f4"}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"cookie-\u4f1a\u8bdd",children:"Cookie \u4f1a\u8bdd"}),"\n",(0,s.jsxs)(e.p,{children:["Cookie \u662f\u5728 Web \u5e94\u7528\u7a0b\u5e8f\u4e2d\u4f20\u9012\u4f1a\u8bdd ID \u7684\u6700\u5e38\u7528\u65b9\u6cd5\u3002WebFrame \u63d0\u4f9b\u4e86 ",(0,s.jsx)(e.code,{children:"CookiePropagator"})," \u5b9e\u73b0\uff0c\u7528\u4e8e\u901a\u8fc7 HTTP Cookie \u673a\u5236\u4f20\u9012\u4f1a\u8bdd ID\u3002"]}),"\n",(0,s.jsx)(e.h3,{id:"cookiepropagator-\u57fa\u672c\u7528\u6cd5",children:"CookiePropagator \u57fa\u672c\u7528\u6cd5"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:'import "github.com/fyerfyer/fyer-webframe/web/session/cookiepropagator"\r\n\r\n// \u521b\u5efa Cookie \u4f20\u64ad\u5668\r\npropagator := cookiepropagator.NewCookiePropagator()\r\n\r\n// \u6216\u8005\u4f7f\u7528\u9009\u9879\u914d\u7f6e\r\npropagator := cookiepropagator.NewCookiePropagator(\r\n    cookiepropagator.WithCookieName("my_session"),\r\n    cookiepropagator.WithCookiePath("/"),\r\n    cookiepropagator.WithCookieMaxAge(3600),  // 1\u5c0f\u65f6\r\n    cookiepropagator.WithCookieSecure(true),\r\n    cookiepropagator.WithCookieHTTPOnly(true),\r\n    cookiepropagator.WithSameSite(http.SameSiteStrictMode),\r\n)\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u914d\u7f6e\u9009\u9879",children:"\u914d\u7f6e\u9009\u9879"}),"\n",(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.code,{children:"CookiePropagator"})," \u652f\u6301\u4ee5\u4e0b\u914d\u7f6e\u9009\u9879\uff1a"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:"// \u8bbe\u7f6e cookie \u540d\u79f0\r\nWithCookieName(name string)\r\n\r\n// \u8bbe\u7f6e cookie \u8def\u5f84\r\nWithCookiePath(path string)\r\n\r\n// \u8bbe\u7f6e cookie \u57df\r\nWithCookieDomain(domain string)\r\n\r\n// \u8bbe\u7f6e cookie \u6700\u5927\u5b58\u6d3b\u65f6\u95f4\uff08\u79d2\uff09\r\nWithCookieMaxAge(maxAge int)\r\n\r\n// \u8bbe\u7f6e cookie \u5b89\u5168\u6807\u5fd7\r\nWithCookieSecure(secure bool)\r\n\r\n// \u8bbe\u7f6e cookie HTTP only \u6807\u5fd7\r\nWithCookieHTTPOnly(httpOnly bool)\r\n\r\n// \u8bbe\u7f6e cookie SameSite \u5c5e\u6027\r\nWithSameSite(sameSite http.SameSite)\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u5b89\u5168\u6700\u4f73\u5b9e\u8df5",children:"\u5b89\u5168\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,s.jsx)(e.p,{children:"\u4e3a\u4e86\u786e\u4fdd\u4f1a\u8bdd\u5b89\u5168\uff0c\u5efa\u8bae\u91c7\u7528\u4ee5\u4e0b Cookie \u914d\u7f6e\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:'propagator := cookiepropagator.NewCookiePropagator(\r\n    cookiepropagator.WithCookieName("session_id"),\r\n    cookiepropagator.WithCookiePath("/"),\r\n    cookiepropagator.WithCookieHTTPOnly(true),  // \u9632\u6b62 JavaScript \u8bbf\u95ee\r\n    cookiepropagator.WithCookieSecure(true),    // \u4ec5\u901a\u8fc7 HTTPS \u53d1\u9001\r\n    cookiepropagator.WithSameSite(http.SameSiteStrictMode),  // \u9632\u6b62 CSRF\r\n)\n'})}),"\n",(0,s.jsx)(e.h2,{id:"redis-\u4f1a\u8bdd\u5b58\u50a8",children:"Redis \u4f1a\u8bdd\u5b58\u50a8"}),"\n",(0,s.jsx)(e.p,{children:"Redis \u662f\u4e00\u79cd\u5e38\u7528\u7684\u4f1a\u8bdd\u5b58\u50a8\u540e\u7aef\uff0c\u9002\u7528\u4e8e\u5206\u5e03\u5f0f\u73af\u5883\u548c\u9700\u8981\u9ad8\u6027\u80fd\u4f1a\u8bdd\u7ba1\u7406\u7684\u573a\u666f\u3002WebFrame \u63d0\u4f9b\u4e86\u57fa\u4e8e Redis \u7684\u4f1a\u8bdd\u5b58\u50a8\u5b9e\u73b0\uff0c\u4f7f\u7528\u8fde\u63a5\u6c60\u7ba1\u7406 Redis \u8fde\u63a5\u3002"}),"\n",(0,s.jsx)(e.h3,{id:"redis-\u4f1a\u8bdd\u5b58\u50a8\u8bbe\u7f6e",children:"Redis \u4f1a\u8bdd\u5b58\u50a8\u8bbe\u7f6e"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:'import (\r\n    "github.com/fyerfyer/fyer-kit/pool"\r\n    "github.com/fyerfyer/fyer-webframe/web/session/redissession"\r\n    "github.com/go-redis/redis/v8"\r\n    "time"\r\n)\r\n\r\n// \u521b\u5efa Redis \u8fde\u63a5\u6c60\r\nredisPool, err := pool.NewPool(\r\n    func(ctx context.Context) (interface{}, error) {\r\n        client := redis.NewClient(&redis.Options{\r\n            Addr:     "localhost:6379",\r\n            Password: "",\r\n            DB:       0,\r\n        })\r\n        return client, nil\r\n    },\r\n    func(ctx context.Context, conn interface{}) error {\r\n        client := conn.(*redis.Client)\r\n        return client.Close()\r\n    },\r\n    pool.WithMaxActive(100),\r\n    pool.WithMaxIdle(10),\r\n    pool.WithIdleTimeout(time.Minute),\r\n)\r\nif err != nil {\r\n    log.Fatalf("Failed to create Redis pool: %v", err)\r\n}\r\n\r\n// \u521b\u5efa Redis \u4f1a\u8bdd\u5b58\u50a8\r\nstorage := redissession.NewRedisStorage(\r\n    redisPool,\r\n    redissession.WithExpireTime(time.Hour), // \u4f1a\u8bdd\u8fc7\u671f\u65f6\u95f4\r\n    redissession.WithPrefix("sess_"),       // \u4f1a\u8bdd\u952e\u524d\u7f00\r\n    redissession.WithCleanupInterval(time.Minute*5), // \u8fc7\u671f\u4f1a\u8bdd\u6e05\u7406\u95f4\u9694\r\n)\n'})}),"\n",(0,s.jsx)(e.h3,{id:"redis-\u4f1a\u8bdd\u5b58\u50a8\u914d\u7f6e",children:"Redis \u4f1a\u8bdd\u5b58\u50a8\u914d\u7f6e"}),"\n",(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.code,{children:"RedisStorage"})," \u652f\u6301\u4ee5\u4e0b\u914d\u7f6e\u9009\u9879\uff1a"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:"// \u8bbe\u7f6e\u4f1a\u8bdd\u8fc7\u671f\u65f6\u95f4\r\nWithExpireTime(expireTime time.Duration)\r\n\r\n// \u8bbe\u7f6e\u4f1a\u8bdd\u952e\u524d\u7f00\r\nWithPrefix(prefix string)\r\n\r\n// \u8bbe\u7f6e\u8fc7\u671f\u4f1a\u8bdd\u6e05\u7406\u95f4\u9694\r\nWithCleanupInterval(interval time.Duration)\n"})}),"\n",(0,s.jsx)(e.h3,{id:"redis-\u4f1a\u8bdd\u5b58\u50a8\u7279\u6027",children:"Redis \u4f1a\u8bdd\u5b58\u50a8\u7279\u6027"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u8fde\u63a5\u6c60\u7ba1\u7406"}),"\uff1a\u4f7f\u7528\u8fde\u63a5\u6c60\u4f18\u5316 Redis \u8fde\u63a5\u7ba1\u7406\uff0c\u63d0\u9ad8\u6027\u80fd\u548c\u8d44\u6e90\u5229\u7528\u7387"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u672c\u5730\u7f13\u5b58"}),"\uff1a\u4f1a\u8bdd\u6570\u636e\u5728\u672c\u5730\u7f13\u5b58\uff0c\u51cf\u5c11\u5bf9 Redis \u7684\u8bf7\u6c42"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u81ea\u52a8\u6e05\u7406"}),"\uff1a\u540e\u53f0\u4efb\u52a1\u5b9a\u671f\u6e05\u7406\u8fc7\u671f\u4f1a\u8bdd"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u5e76\u53d1\u5b89\u5168"}),"\uff1a\u4f7f\u7528\u4e92\u65a5\u9501\u4fdd\u8bc1\u4f1a\u8bdd\u64cd\u4f5c\u7684\u7ebf\u7a0b\u5b89\u5168"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u60f0\u6027\u52a0\u8f7d"}),"\uff1a\u4f1a\u8bdd\u6570\u636e\u6309\u9700\u4ece Redis \u52a0\u8f7d"]}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"\u5b8c\u6574\u793a\u4f8b",children:"\u5b8c\u6574\u793a\u4f8b"}),"\n",(0,s.jsx)(e.p,{children:"\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u4e86\u5982\u4f55\u5728 WebFrame \u5e94\u7528\u4e2d\u96c6\u6210\u4f1a\u8bdd\u7ba1\u7406\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:'package main\r\n\r\nimport (\r\n    "context"\r\n    "fmt"\r\n    "log"\r\n    "time"\r\n\r\n    "github.com/fyerfyer/fyer-kit/pool"\r\n    "github.com/fyerfyer/fyer-webframe/web"\r\n    "github.com/fyerfyer/fyer-webframe/web/middleware/session"\r\n    "github.com/fyerfyer/fyer-webframe/web/session/cookiepropagator"\r\n    "github.com/fyerfyer/fyer-webframe/web/session/redissession"\r\n    "github.com/go-redis/redis/v8"\r\n)\r\n\r\nfunc main() {\r\n    // \u521b\u5efa HTTP \u670d\u52a1\u5668\r\n    server := web.NewHTTPServer()\r\n\r\n    // \u521b\u5efa Redis \u8fde\u63a5\u6c60\r\n    redisPool, err := pool.NewPool(\r\n        func(ctx context.Context) (interface{}, error) {\r\n            client := redis.NewClient(&redis.Options{\r\n                Addr:     "localhost:6379",\r\n                Password: "",\r\n                DB:       0,\r\n            })\r\n            return client, nil\r\n        },\r\n        func(ctx context.Context, conn interface{}) error {\r\n            client := conn.(*redis.Client)\r\n            return client.Close()\r\n        },\r\n        pool.WithMaxActive(100),\r\n        pool.WithMaxIdle(10),\r\n    )\r\n    if err != nil {\r\n        log.Fatalf("Failed to create Redis pool: %v", err)\r\n    }\r\n\r\n    // \u521b\u5efa Redis \u4f1a\u8bdd\u5b58\u50a8\r\n    storage := redissession.NewRedisStorage(\r\n        redisPool,\r\n        redissession.WithExpireTime(time.Hour),\r\n        redissession.WithPrefix("sess_"),\r\n    )\r\n\r\n    // \u521b\u5efa Cookie \u4f1a\u8bdd\u4f20\u64ad\u5668\r\n    propagator := cookiepropagator.NewCookiePropagator(\r\n        cookiepropagator.WithCookieName("session_id"),\r\n        cookiepropagator.WithCookieHTTPOnly(true),\r\n        cookiepropagator.WithCookieMaxAge(3600),\r\n    )\r\n\r\n    // \u521b\u5efa\u4f1a\u8bdd\u7ba1\u7406\u5668\r\n    sessionManager := session.NewMagager(storage, propagator, "session")\r\n\r\n    // \u521b\u5efa\u4f1a\u8bdd\u4e2d\u95f4\u4ef6\r\n    sessionMiddleware := session.NewSessionMiddleware(sessionManager, true).\r\n        WithInitializer(func(s session.Session) error {\r\n            // \u8bbe\u7f6e\u4f1a\u8bdd\u521d\u59cb\u503c\r\n            ctx := context.Background()\r\n            err := s.Set(ctx, "created_at", time.Now().Format(time.RFC3339))\r\n            if err != nil {\r\n                return err\r\n            }\r\n            \r\n            err = s.Set(ctx, "visits", 1)\r\n            if err != nil {\r\n                return err\r\n            }\r\n            \r\n            return nil\r\n        })\r\n\r\n    // \u6ce8\u518c\u4f1a\u8bdd\u4e2d\u95f4\u4ef6\r\n    server.Use("*", "/*", sessionMiddleware.Build())\r\n\r\n    // \u6ce8\u518c\u8def\u7531\u5904\u7406\u7a0b\u5e8f\r\n    server.Get("/", func(ctx *web.Context) {\r\n        sess, err := sessionManager.GetSession(ctx)\r\n        if err != nil {\r\n            ctx.String(500, "Failed to get session: %v", err)\r\n            return\r\n        }\r\n\r\n        bgCtx := context.Background()\r\n        \r\n        // \u83b7\u53d6\u8bbf\u95ee\u6b21\u6570\r\n        visitsVal, err := sess.Get(bgCtx, "visits")\r\n        if err != nil {\r\n            ctx.String(500, "Failed to get visits: %v", err)\r\n            return\r\n        }\r\n        \r\n        visits, ok := visitsVal.(float64)\r\n        if !ok {\r\n            visits = 0\r\n        }\r\n        \r\n        // \u589e\u52a0\u8bbf\u95ee\u6b21\u6570\r\n        visits++\r\n        err = sess.Set(bgCtx, "visits", visits)\r\n        if err != nil {\r\n            ctx.String(500, "Failed to update visits: %v", err)\r\n            return\r\n        }\r\n\r\n        // \u83b7\u53d6\u521b\u5efa\u65f6\u95f4\r\n        createdAt, _ := sess.Get(bgCtx, "created_at")\r\n        \r\n        ctx.JSON(200, map[string]interface{}{\r\n            "session_id": sess.ID(),\r\n            "visits":     visits,\r\n            "created_at": createdAt,\r\n        })\r\n    })\r\n\r\n    // \u767b\u5f55\u793a\u4f8b\r\n    server.Post("/login", func(ctx *web.Context) {\r\n        // \u83b7\u53d6\u7528\u6237\u51ed\u636e\r\n        username := ctx.FormValue("username").Value\r\n        password := ctx.FormValue("password").Value\r\n        \r\n        // \u9a8c\u8bc1\u51ed\u636e (\u793a\u4f8b)\r\n        if username == "admin" && password == "password" {\r\n            // \u83b7\u53d6\u4f1a\u8bdd\r\n            sess, err := sessionManager.GetSession(ctx)\r\n            if err != nil {\r\n                ctx.String(500, "Failed to get session: %v", err)\r\n                return\r\n            }\r\n            \r\n            // \u8bbe\u7f6e\u7528\u6237\u4fe1\u606f\u5230\u4f1a\u8bdd\r\n            bgCtx := context.Background()\r\n            err = sess.Set(bgCtx, "user_id", 1)\r\n            if err != nil {\r\n                ctx.String(500, "Failed to set user_id: %v", err)\r\n                return\r\n            }\r\n            \r\n            err = sess.Set(bgCtx, "username", username)\r\n            if err != nil {\r\n                ctx.String(500, "Failed to set username: %v", err)\r\n                return\r\n            }\r\n            \r\n            err = sess.Set(bgCtx, "logged_in_at", time.Now().Format(time.RFC3339))\r\n            if err != nil {\r\n                ctx.String(500, "Failed to set logged_in_at: %v", err)\r\n                return\r\n            }\r\n            \r\n            ctx.JSON(200, map[string]string{\r\n                "message": "Login successful",\r\n            })\r\n        } else {\r\n            ctx.JSON(401, map[string]string{\r\n                "error": "Invalid credentials",\r\n            })\r\n        }\r\n    })\r\n\r\n    // \u767b\u51fa\u793a\u4f8b\r\n    server.Post("/logout", func(ctx *web.Context) {\r\n        err := sessionManager.DeleteSession(ctx)\r\n        if err != nil {\r\n            ctx.String(500, "Failed to delete session: %v", err)\r\n            return\r\n        }\r\n        \r\n        ctx.JSON(200, map[string]string{\r\n            "message": "Logout successful",\r\n        })\r\n    })\r\n\r\n    // \u53d7\u4fdd\u62a4\u7684 API \u793a\u4f8b\r\n    server.Get("/profile", func(ctx *web.Context) {\r\n        sess, err := sessionManager.GetSession(ctx)\r\n        if err != nil {\r\n            ctx.JSON(401, map[string]string{\r\n                "error": "Authentication required",\r\n            })\r\n            return\r\n        }\r\n        \r\n        bgCtx := context.Background()\r\n        userID, err := sess.Get(bgCtx, "user_id")\r\n        if err != nil || userID == nil {\r\n            ctx.JSON(401, map[string]string{\r\n                "error": "Authentication required",\r\n            })\r\n            return\r\n        }\r\n        \r\n        // \u83b7\u53d6\u7528\u6237\u4e2a\u4eba\u8d44\u6599\r\n        username, _ := sess.Get(bgCtx, "username")\r\n        \r\n        ctx.JSON(200, map[string]interface{}{\r\n            "user_id":  userID,\r\n            "username": username,\r\n            "email":    fmt.Sprintf("%s@example.com", username),\r\n        })\r\n    })\r\n\r\n    // \u542f\u52a8\u670d\u52a1\u5668\r\n    log.Println("Server starting on :8080")\r\n    err = server.Start(":8080")\r\n    if err != nil {\r\n        log.Fatalf("Server failed to start: %v", err)\r\n    }\r\n}\n'})})]})}function g(r={}){const{wrapper:e}={...(0,o.R)(),...r.components};return e?(0,s.jsx)(e,{...r,children:(0,s.jsx)(d,{...r})}):d(r)}},8453:(r,e,n)=>{n.d(e,{R:()=>t,x:()=>a});var i=n(6540);const s={},o=i.createContext(s);function t(r){const e=i.useContext(o);return i.useMemo((function(){return"function"==typeof r?r(e):{...e,...r}}),[e,r])}function a(r){let e;return e=r.disableParentContext?"function"==typeof r.components?r.components(s):r.components||s:t(r.components),i.createElement(o.Provider,{value:e},r.children)}}}]);