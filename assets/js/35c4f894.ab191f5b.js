"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[939],{270:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>u,frontMatter:()=>s,metadata:()=>t,toc:()=>a});const t=JSON.parse('{"id":"web/middleware/middleware-manage","title":"Middleware","description":"\u4e2d\u95f4\u4ef6\u662f WebFrame \u6846\u67b6\u7684\u6838\u5fc3\u529f\u80fd\u4e4b\u4e00\uff0c\u5b83\u63d0\u4f9b\u4e86\u4e00\u79cd\u5f3a\u5927\u800c\u7075\u6d3b\u7684\u673a\u5236\uff0c\u5141\u8bb8\u60a8\u5728\u8bf7\u6c42\u5904\u7406\u6d41\u7a0b\u4e2d\u63d2\u5165\u81ea\u5b9a\u4e49\u903b\u8f91\u3002","source":"@site/docs/web/middleware/middleware-manage.md","sourceDirName":"web/middleware","slug":"/web/middleware/middleware-manage","permalink":"/fyer-webframe/docs/web/middleware/middleware-manage","draft":false,"unlisted":false,"editUrl":"https://github.com/fyerfyer/fyer-webframe/tree/main/docs/web/middleware/middleware-manage.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Built-in Middleware","permalink":"/fyer-webframe/docs/web/middleware/implemented-middleware"},"next":{"title":"Request Handle","permalink":"/fyer-webframe/docs/web/request-handle/"}}');var i=r(4848),d=r(8453);const s={},c="Middleware",l={},a=[{value:"WebFrame \u4e2d\u95f4\u4ef6\u7684\u6838\u5fc3\u6982\u5ff5",id:"webframe-\u4e2d\u95f4\u4ef6\u7684\u6838\u5fc3\u6982\u5ff5",level:3},{value:"\u4e2d\u95f4\u4ef6\u7c7b\u578b",id:"\u4e2d\u95f4\u4ef6\u7c7b\u578b",level:3},{value:"\u4e2d\u95f4\u4ef6\u6267\u884c\u987a\u5e8f",id:"\u4e2d\u95f4\u4ef6\u6267\u884c\u987a\u5e8f",level:3},{value:"\u4f7f\u7528\u4e2d\u95f4\u4ef6",id:"\u4f7f\u7528\u4e2d\u95f4\u4ef6",level:2},{value:"\u6ce8\u518c\u4e2d\u95f4\u4ef6",id:"\u6ce8\u518c\u4e2d\u95f4\u4ef6",level:3},{value:"1. \u4f7f\u7528 <code>Use</code> \u65b9\u6cd5",id:"1-\u4f7f\u7528-use-\u65b9\u6cd5",level:4},{value:"2. \u4f7f\u7528\u4e2d\u95f4\u4ef6\u7ba1\u7406\u5668",id:"2-\u4f7f\u7528\u4e2d\u95f4\u4ef6\u7ba1\u7406\u5668",level:4},{value:"3. \u4f7f\u7528\u8def\u7531\u94fe\u5f0f API",id:"3-\u4f7f\u7528\u8def\u7531\u94fe\u5f0f-api",level:4},{value:"4. \u4f7f\u7528\u8def\u7531\u7ec4\u4e2d\u95f4\u4ef6",id:"4-\u4f7f\u7528\u8def\u7531\u7ec4\u4e2d\u95f4\u4ef6",level:4},{value:"\u4e2d\u95f4\u4ef6\u6d41\u7a0b\u63a7\u5236",id:"\u4e2d\u95f4\u4ef6\u6d41\u7a0b\u63a7\u5236",level:3},{value:"1. \u7ec8\u6b62\u8bf7\u6c42\u5904\u7406\uff08Abort\uff09",id:"1-\u7ec8\u6b62\u8bf7\u6c42\u5904\u7406abort",level:4},{value:"2. \u68c0\u67e5\u8bf7\u6c42\u662f\u5426\u5df2\u7ec8\u6b62",id:"2-\u68c0\u67e5\u8bf7\u6c42\u662f\u5426\u5df2\u7ec8\u6b62",level:4},{value:"3. \u663e\u5f0f\u8c03\u7528\u4e0b\u4e00\u4e2a\u5904\u7406\u5668",id:"3-\u663e\u5f0f\u8c03\u7528\u4e0b\u4e00\u4e2a\u5904\u7406\u5668",level:4},{value:"\u4e2d\u95f4\u4ef6\u5171\u4eab\u6570\u636e",id:"\u4e2d\u95f4\u4ef6\u5171\u4eab\u6570\u636e",level:3},{value:"\u7f16\u5199\u81ea\u5b9a\u4e49\u4e2d\u95f4\u4ef6",id:"\u7f16\u5199\u81ea\u5b9a\u4e49\u4e2d\u95f4\u4ef6",level:2},{value:"\u57fa\u672c\u7ed3\u6784",id:"\u57fa\u672c\u7ed3\u6784",level:3},{value:"\u5e26\u914d\u7f6e\u7684\u4e2d\u95f4\u4ef6",id:"\u5e26\u914d\u7f6e\u7684\u4e2d\u95f4\u4ef6",level:3},{value:"\u6784\u5efa\u5668\u6a21\u5f0f",id:"\u6784\u5efa\u5668\u6a21\u5f0f",level:3},{value:"\u4e2d\u95f4\u4ef6\u793a\u4f8b",id:"\u4e2d\u95f4\u4ef6\u793a\u4f8b",level:3},{value:"1. \u8bf7\u6c42\u65e5\u5fd7\u4e2d\u95f4\u4ef6",id:"1-\u8bf7\u6c42\u65e5\u5fd7\u4e2d\u95f4\u4ef6",level:4},{value:"2. \u9519\u8bef\u6062\u590d\u4e2d\u95f4\u4ef6",id:"2-\u9519\u8bef\u6062\u590d\u4e2d\u95f4\u4ef6",level:4},{value:"3. \u8ba4\u8bc1\u4e2d\u95f4\u4ef6",id:"3-\u8ba4\u8bc1\u4e2d\u95f4\u4ef6",level:4},{value:"4. CORS \u4e2d\u95f4\u4ef6",id:"4-cors-\u4e2d\u95f4\u4ef6",level:4},{value:"5. \u8bf7\u6c42 ID \u4e2d\u95f4\u4ef6",id:"5-\u8bf7\u6c42-id-\u4e2d\u95f4\u4ef6",level:4},{value:"\u5b8c\u6574\u793a\u4f8b",id:"\u5b8c\u6574\u793a\u4f8b",level:2}];function o(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,d.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"middleware",children:"Middleware"})}),"\n",(0,i.jsx)(n.p,{children:"\u4e2d\u95f4\u4ef6\u662f WebFrame \u6846\u67b6\u7684\u6838\u5fc3\u529f\u80fd\u4e4b\u4e00\uff0c\u5b83\u63d0\u4f9b\u4e86\u4e00\u79cd\u5f3a\u5927\u800c\u7075\u6d3b\u7684\u673a\u5236\uff0c\u5141\u8bb8\u60a8\u5728\u8bf7\u6c42\u5904\u7406\u6d41\u7a0b\u4e2d\u63d2\u5165\u81ea\u5b9a\u4e49\u903b\u8f91\u3002"}),"\n",(0,i.jsx)(n.h3,{id:"webframe-\u4e2d\u95f4\u4ef6\u7684\u6838\u5fc3\u6982\u5ff5",children:"WebFrame \u4e2d\u95f4\u4ef6\u7684\u6838\u5fc3\u6982\u5ff5"}),"\n",(0,i.jsx)(n.p,{children:"\u5728 WebFrame \u4e2d\uff0c\u4e2d\u95f4\u4ef6\u88ab\u5b9a\u4e49\u4e3a\u4ee5\u4e0b\u51fd\u6570\u7c7b\u578b\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"// HandlerFunc \u5b9a\u4e49\u8bf7\u6c42\u5904\u7406\u51fd\u6570\r\ntype HandlerFunc func(ctx *Context)\r\n\r\n// Middleware \u5b9a\u4e49\u4e2d\u95f4\u4ef6\u51fd\u6570\r\ntype Middleware func(HandlerFunc) HandlerFunc\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u8fd9\u79cd\u6d0b\u8471\u6a21\u578b\u8bbe\u8ba1\u4f7f\u4e2d\u95f4\u4ef6\u53ef\u4ee5\u5728\u8c03\u7528\u4e0b\u4e00\u4e2a\u5904\u7406\u51fd\u6570\u524d\u548c\u540e\u6267\u884c\u4ee3\u7801\uff0c\u5f62\u6210\u4e00\u4e2a\u56f4\u7ed5\u5b9e\u9645\u5904\u7406\u5668\u7684\u5904\u7406\u94fe\u3002"}),"\n",(0,i.jsx)(n.h3,{id:"\u4e2d\u95f4\u4ef6\u7c7b\u578b",children:"\u4e2d\u95f4\u4ef6\u7c7b\u578b"}),"\n",(0,i.jsx)(n.p,{children:"WebFrame \u652f\u6301\u591a\u79cd\u7c7b\u578b\u7684\u4e2d\u95f4\u4ef6\uff0c\u6839\u636e\u5176\u6ce8\u518c\u8def\u5f84\u7684\u4e0d\u540c\u5206\u4e3a\uff1a"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u9759\u6001\u4e2d\u95f4\u4ef6"}),"\uff1a\u5339\u914d\u786e\u5207\u7684\u8def\u5f84\uff0c\u5982 users"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u53c2\u6570\u4e2d\u95f4\u4ef6"}),"\uff1a\u5339\u914d\u5e26\u53c2\u6570\u7684\u8def\u5f84\uff0c\u5982 ",(0,i.jsx)(n.code,{children:"/users/:id"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u6b63\u5219\u4e2d\u95f4\u4ef6"}),"\uff1a\u5339\u914d\u5e26\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u8def\u5f84\uff0c\u5982 ",(0,i.jsx)(n.code,{children:"/users/:id([0-9]+)"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u901a\u914d\u7b26\u4e2d\u95f4\u4ef6"}),"\uff1a\u5339\u914d\u901a\u914d\u7b26\u8def\u5f84\uff0c\u5982 ",(0,i.jsx)(n.code,{children:"/users/*"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u5168\u5c40\u4e2d\u95f4\u4ef6"}),"\uff1a\u5339\u914d\u6240\u6709\u8def\u5f84\uff0c\u901a\u5e38\u6ce8\u518c\u4e3a ",(0,i.jsx)(n.code,{children:"/*"})]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"\u4e2d\u95f4\u4ef6\u6267\u884c\u987a\u5e8f",children:"\u4e2d\u95f4\u4ef6\u6267\u884c\u987a\u5e8f"}),"\n",(0,i.jsx)(n.p,{children:"\u4e2d\u95f4\u4ef6\u6267\u884c\u9075\u5faa\u4ee5\u4e0b\u89c4\u5219\uff1a"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u6309\u5339\u914d\u7279\u5b9a\u6027"}),"\uff1a\u9759\u6001\u8def\u5f84 > \u6b63\u5219\u8def\u5f84 > \u53c2\u6570\u8def\u5f84 > \u901a\u914d\u7b26\u8def\u5f84"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u6309\u6ce8\u518c\u987a\u5e8f"}),"\uff1a\u5148\u6ce8\u518c\u7684\u4e2d\u95f4\u4ef6\u5148\u6267\u884c"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u6d0b\u8471\u6a21\u578b\u6267\u884c"}),"\uff1a\u8bf7\u6c42\u9636\u6bb5\u4ece\u5916\u5230\u5185\uff0c\u54cd\u5e94\u9636\u6bb5\u4ece\u5185\u5230\u5916"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u4e3e\u4f8b\u8bf4\u660e\u6d0b\u8471\u6a21\u578b\u6267\u884c\u987a\u5e8f\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'s.Use("GET", "/path", func(next HandlerFunc) HandlerFunc {\r\n    return func(ctx *Context) {\r\n        // \u8bf7\u6c42\u9636\u6bb5 (1)\r\n        next(ctx)\r\n        // \u54cd\u5e94\u9636\u6bb5 (6)\r\n    }\r\n})\r\n\r\ns.Use("GET", "/path", func(next HandlerFunc) HandlerFunc {\r\n    return func(ctx *Context) {\r\n        // \u8bf7\u6c42\u9636\u6bb5 (2)\r\n        next(ctx)\r\n        // \u54cd\u5e94\u9636\u6bb5 (5)\r\n    }\r\n})\r\n\r\ns.Get("/path", func(ctx *Context) {\r\n    // \u5904\u7406\u8bf7\u6c42 (3)\r\n    // \u6784\u5efa\u54cd\u5e94 (4)\r\n})\n'})}),"\n",(0,i.jsx)(n.p,{children:"\u6267\u884c\u987a\u5e8f\u662f\uff1a(1) \u2192 (2) \u2192 (3) \u2192 (4) \u2192 (5) \u2192 (6)"}),"\n",(0,i.jsx)(n.h2,{id:"\u4f7f\u7528\u4e2d\u95f4\u4ef6",children:"\u4f7f\u7528\u4e2d\u95f4\u4ef6"}),"\n",(0,i.jsx)(n.h3,{id:"\u6ce8\u518c\u4e2d\u95f4\u4ef6",children:"\u6ce8\u518c\u4e2d\u95f4\u4ef6"}),"\n",(0,i.jsx)(n.p,{children:"WebFrame \u63d0\u4f9b\u4e86\u591a\u79cd\u6ce8\u518c\u4e2d\u95f4\u4ef6\u7684\u65b9\u5f0f\uff1a"}),"\n",(0,i.jsxs)(n.h4,{id:"1-\u4f7f\u7528-use-\u65b9\u6cd5",children:["1. \u4f7f\u7528 ",(0,i.jsx)(n.code,{children:"Use"})," \u65b9\u6cd5"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'// \u5168\u5c40\u4e2d\u95f4\u4ef6\r\ns.Use("*", "/*", loggerMiddleware)\r\n\r\n// \u7279\u5b9a HTTP \u65b9\u6cd5\u7684\u4e2d\u95f4\u4ef6\r\ns.Use("GET", "/api/*", authMiddleware)\r\n\r\n// \u7279\u5b9a\u8def\u5f84\u7684\u4e2d\u95f4\u4ef6\r\ns.Use("POST", "/users/:id", validateUserMiddleware)\n'})}),"\n",(0,i.jsx)(n.h4,{id:"2-\u4f7f\u7528\u4e2d\u95f4\u4ef6\u7ba1\u7406\u5668",children:"2. \u4f7f\u7528\u4e2d\u95f4\u4ef6\u7ba1\u7406\u5668"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'// \u5168\u5c40\u4e2d\u95f4\u4ef6\r\ns.Middleware().Global().Add(recoveryMiddleware, loggerMiddleware)\r\n\r\n// \u7279\u5b9a\u8def\u5f84\u4e2d\u95f4\u4ef6\r\ns.Middleware().For("GET", "/api/users/*").Add(authMiddleware)\r\n\r\n// \u6761\u4ef6\u4e2d\u95f4\u4ef6\uff08\u53ea\u6709\u6ee1\u8db3\u6761\u4ef6\u65f6\u624d\u6267\u884c\uff09\r\ns.Middleware().When(func(c *Context) bool {\r\n    return c.GetHeader("X-API-Version") == "v2"\r\n}).Add(apiVersionMiddleware)\n'})}),"\n",(0,i.jsx)(n.h4,{id:"3-\u4f7f\u7528\u8def\u7531\u94fe\u5f0f-api",children:"3. \u4f7f\u7528\u8def\u7531\u94fe\u5f0f API"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'s.Get("/admin/dashboard", dashboardHandler).\r\n    Middleware(authMiddleware, adminCheckMiddleware)\n'})}),"\n",(0,i.jsx)(n.h4,{id:"4-\u4f7f\u7528\u8def\u7531\u7ec4\u4e2d\u95f4\u4ef6",children:"4. \u4f7f\u7528\u8def\u7531\u7ec4\u4e2d\u95f4\u4ef6"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'// \u521b\u5efa\u5e26\u4e2d\u95f4\u4ef6\u7684\u8def\u7531\u7ec4\r\napi := s.Group("/api").Use(\r\n    authMiddleware,\r\n    rateLimitMiddleware,\r\n)\r\n\r\n// \u8be5\u7ec4\u4e2d\u7684\u6240\u6709\u8def\u7531\u90fd\u4f1a\u5e94\u7528\u4e0a\u8ff0\u4e2d\u95f4\u4ef6\r\napi.Get("/users", listUsers)\r\napi.Post("/users", createUser)\n'})}),"\n",(0,i.jsx)(n.h3,{id:"\u4e2d\u95f4\u4ef6\u6d41\u7a0b\u63a7\u5236",children:"\u4e2d\u95f4\u4ef6\u6d41\u7a0b\u63a7\u5236"}),"\n",(0,i.jsx)(n.p,{children:"WebFrame \u63d0\u4f9b\u4e86\u4ee5\u4e0b\u63a7\u5236\u4e2d\u95f4\u4ef6\u6267\u884c\u6d41\u7a0b\u7684\u65b9\u6cd5\uff1a"}),"\n",(0,i.jsx)(n.h4,{id:"1-\u7ec8\u6b62\u8bf7\u6c42\u5904\u7406abort",children:"1. \u7ec8\u6b62\u8bf7\u6c42\u5904\u7406\uff08Abort\uff09"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'func authMiddleware(next HandlerFunc) HandlerFunc {\r\n    return func(ctx *Context) {\r\n        token := ctx.GetHeader("Authorization")\r\n        if token == "" {\r\n            ctx.Abort()  // \u7ec8\u6b62\u540e\u7eed\u4e2d\u95f4\u4ef6\u548c\u5904\u7406\u5668\u6267\u884c\r\n            ctx.JSON(401, map[string]string{"error": "Unauthorized"})\r\n            return\r\n        }\r\n        next(ctx)\r\n    }\r\n}\n'})}),"\n",(0,i.jsx)(n.h4,{id:"2-\u68c0\u67e5\u8bf7\u6c42\u662f\u5426\u5df2\u7ec8\u6b62",children:"2. \u68c0\u67e5\u8bf7\u6c42\u662f\u5426\u5df2\u7ec8\u6b62"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'func loggingMiddleware(next HandlerFunc) HandlerFunc {\r\n    return func(ctx *Context) {\r\n        // \u8bf7\u6c42\u9636\u6bb5\r\n        next(ctx)\r\n        // \u54cd\u5e94\u9636\u6bb5\r\n        if !ctx.IsAborted() {\r\n            // \u8bf7\u6c42\u672a\u88ab\u7ec8\u6b62\u65f6\u624d\u6267\u884c\u65e5\u5fd7\u8bb0\u5f55\r\n            log.Printf("Request completed with status: %d", ctx.RespStatusCode)\r\n        }\r\n    }\r\n}\n'})}),"\n",(0,i.jsx)(n.h4,{id:"3-\u663e\u5f0f\u8c03\u7528\u4e0b\u4e00\u4e2a\u5904\u7406\u5668",children:"3. \u663e\u5f0f\u8c03\u7528\u4e0b\u4e00\u4e2a\u5904\u7406\u5668"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'func timingMiddleware(next HandlerFunc) HandlerFunc {\r\n    return func(ctx *Context) {\r\n        start := time.Now()\r\n        \r\n        ctx.Next(next)  // \u663e\u5f0f\u8c03\u7528\u4e0b\u4e00\u4e2a\u5904\u7406\u5668\r\n        \r\n        duration := time.Since(start)\r\n        log.Printf("Request took %v", duration)\r\n    }\r\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"\u4e2d\u95f4\u4ef6\u5171\u4eab\u6570\u636e",children:"\u4e2d\u95f4\u4ef6\u5171\u4eab\u6570\u636e"}),"\n",(0,i.jsxs)(n.p,{children:["\u60a8\u53ef\u4ee5\u4f7f\u7528 ",(0,i.jsx)(n.code,{children:"Context.UserValues"})," \u5728\u4e2d\u95f4\u4ef6\u548c\u5904\u7406\u5668\u4e4b\u95f4\u5171\u4eab\u6570\u636e\uff1a"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'func userLoaderMiddleware(next HandlerFunc) HandlerFunc {\r\n    return func(ctx *Context) {\r\n        userID := ctx.PathInt("id").Value\r\n        user, err := getUserFromDB(userID)\r\n        if err != nil {\r\n            ctx.JSON(500, map[string]string{"error": "Failed to load user"})\r\n            ctx.Abort()\r\n            return\r\n        }\r\n        \r\n        // \u5c06\u7528\u6237\u6570\u636e\u5b58\u50a8\u5728\u4e0a\u4e0b\u6587\u4e2d\r\n        ctx.UserValues["user"] = user\r\n        next(ctx)\r\n    }\r\n}\r\n\r\n// \u5904\u7406\u5668\u53ef\u4ee5\u8bbf\u95ee\u4e2d\u95f4\u4ef6\u5b58\u50a8\u7684\u6570\u636e\r\nfunc getUserProfile(ctx *Context) {\r\n    user, ok := ctx.UserValues["user"].(User)\r\n    if !ok {\r\n        ctx.JSON(500, map[string]string{"error": "User not found in context"})\r\n        return\r\n    }\r\n    \r\n    ctx.JSON(200, user.Profile)\r\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"\u7f16\u5199\u81ea\u5b9a\u4e49\u4e2d\u95f4\u4ef6",children:"\u7f16\u5199\u81ea\u5b9a\u4e49\u4e2d\u95f4\u4ef6"}),"\n",(0,i.jsx)(n.h3,{id:"\u57fa\u672c\u7ed3\u6784",children:"\u57fa\u672c\u7ed3\u6784"}),"\n",(0,i.jsx)(n.p,{children:"\u81ea\u5b9a\u4e49\u4e2d\u95f4\u4ef6\u9075\u5faa\u4ee5\u4e0b\u57fa\u672c\u7ed3\u6784\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"func MyMiddleware(next web.HandlerFunc) web.HandlerFunc {\r\n    // \u521d\u59cb\u5316\u9636\u6bb5\uff1a\u5728\u670d\u52a1\u5668\u542f\u52a8\u65f6\u6267\u884c\u4e00\u6b21\r\n    \r\n    return func(ctx *web.Context) {\r\n        // \u8bf7\u6c42\u9636\u6bb5\uff1a\u5728\u8c03\u7528\u4e0b\u4e00\u4e2a\u5904\u7406\u5668\u524d\u6267\u884c\r\n        \r\n        next(ctx)  // \u8c03\u7528\u4e0b\u4e00\u4e2a\u5904\u7406\u5668\u6216\u4e2d\u95f4\u4ef6\r\n        \r\n        // \u54cd\u5e94\u9636\u6bb5\uff1a\u5728\u4e0b\u4e00\u4e2a\u5904\u7406\u5668\u8fd4\u56de\u540e\u6267\u884c\r\n    }\r\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u5e26\u914d\u7f6e\u7684\u4e2d\u95f4\u4ef6",children:"\u5e26\u914d\u7f6e\u7684\u4e2d\u95f4\u4ef6"}),"\n",(0,i.jsx)(n.p,{children:"\u5bf9\u4e8e\u9700\u8981\u914d\u7f6e\u9009\u9879\u7684\u4e2d\u95f4\u4ef6\uff0c\u901a\u5e38\u91c7\u7528\u95ed\u5305\u6216\u6784\u5efa\u5668\u6a21\u5f0f\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'// \u9009\u9879\u6a21\u5f0f\r\ntype LoggerOptions struct {\r\n    Format      string\r\n    LogRequest  bool\r\n    LogResponse bool\r\n}\r\n\r\nfunc NewLoggerMiddleware(options LoggerOptions) web.Middleware {\r\n    return func(next web.HandlerFunc) web.HandlerFunc {\r\n        return func(ctx *web.Context) {\r\n            if options.LogRequest {\r\n                log.Printf("Request: %s %s", ctx.Req.Method, ctx.Req.URL.Path)\r\n            }\r\n            \r\n            next(ctx)\r\n            \r\n            if options.LogResponse {\r\n                log.Printf("Response: %d (%s %s)", \r\n                    ctx.RespStatusCode, ctx.Req.Method, ctx.Req.URL.Path)\r\n            }\r\n        }\r\n    }\r\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"\u4f7f\u7528\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'s.Use("*", "/*", NewLoggerMiddleware(LoggerOptions{\r\n    Format:      "standard",\r\n    LogRequest:  true,\r\n    LogResponse: true,\r\n}))\n'})}),"\n",(0,i.jsx)(n.h3,{id:"\u6784\u5efa\u5668\u6a21\u5f0f",children:"\u6784\u5efa\u5668\u6a21\u5f0f"}),"\n",(0,i.jsx)(n.p,{children:"\u66f4\u590d\u6742\u7684\u4e2d\u95f4\u4ef6\u53ef\u4ee5\u4f7f\u7528\u6784\u5efa\u5668\u6a21\u5f0f\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'// \u6784\u5efa\u5668\u6a21\u5f0f\r\ntype RateLimiterBuilder struct {\r\n    limit        int\r\n    windowSeconds int\r\n    keyFunc      func(*web.Context) string\r\n}\r\n\r\nfunc NewRateLimiterBuilder() *RateLimiterBuilder {\r\n    return &RateLimiterBuilder{\r\n        limit:        100,\r\n        windowSeconds: 60,\r\n        keyFunc:      defaultKeyFunc,\r\n    }\r\n}\r\n\r\nfunc (b *RateLimiterBuilder) WithLimit(limit int) *RateLimiterBuilder {\r\n    b.limit = limit\r\n    return b\r\n}\r\n\r\nfunc (b *RateLimiterBuilder) WithWindow(seconds int) *RateLimiterBuilder {\r\n    b.windowSeconds = seconds\r\n    return b\r\n}\r\n\r\nfunc (b *RateLimiterBuilder) WithKeyFunc(fn func(*web.Context) string) *RateLimiterBuilder {\r\n    b.keyFunc = fn\r\n    return b\r\n}\r\n\r\nfunc (b *RateLimiterBuilder) Build() web.Middleware {\r\n    // \u521b\u5efa\u901f\u7387\u9650\u5236\u5668\r\n    limiter := createRateLimiter(b.limit, b.windowSeconds)\r\n    \r\n    return func(next web.HandlerFunc) web.HandlerFunc {\r\n        return func(ctx *web.Context) {\r\n            key := b.keyFunc(ctx)\r\n            if !limiter.Allow(key) {\r\n                ctx.JSON(429, map[string]string{"error": "Too many requests"})\r\n                ctx.Abort()\r\n                return\r\n            }\r\n            next(ctx)\r\n        }\r\n    }\r\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"\u4f7f\u7528\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'limiter := NewRateLimiterBuilder().\r\n    WithLimit(200).\r\n    WithWindow(30).\r\n    WithKeyFunc(func(ctx *web.Context) string {\r\n        return ctx.ClientIP()\r\n    }).\r\n    Build()\r\n\r\ns.Use("*", "/*", limiter)\n'})}),"\n",(0,i.jsx)(n.h3,{id:"\u4e2d\u95f4\u4ef6\u793a\u4f8b",children:"\u4e2d\u95f4\u4ef6\u793a\u4f8b"}),"\n",(0,i.jsx)(n.p,{children:"\u4ee5\u4e0b\u662f\u51e0\u4e2a\u5e38\u7528\u4e2d\u95f4\u4ef6\u7684\u5b9e\u73b0\u793a\u4f8b\uff1a"}),"\n",(0,i.jsx)(n.h4,{id:"1-\u8bf7\u6c42\u65e5\u5fd7\u4e2d\u95f4\u4ef6",children:"1. \u8bf7\u6c42\u65e5\u5fd7\u4e2d\u95f4\u4ef6"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'func RequestLoggerMiddleware(next web.HandlerFunc) web.HandlerFunc {\r\n    return func(ctx *web.Context) {\r\n        start := time.Now()\r\n        method := ctx.Req.Method\r\n        path := ctx.Req.URL.Path\r\n        \r\n        log.Printf("Request started: %s %s", method, path)\r\n        \r\n        next(ctx)\r\n        \r\n        duration := time.Since(start)\r\n        log.Printf("Request completed: %s %s %d %v", \r\n            method, path, ctx.RespStatusCode, duration)\r\n    }\r\n}\n'})}),"\n",(0,i.jsx)(n.h4,{id:"2-\u9519\u8bef\u6062\u590d\u4e2d\u95f4\u4ef6",children:"2. \u9519\u8bef\u6062\u590d\u4e2d\u95f4\u4ef6"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'func RecoveryMiddleware(next web.HandlerFunc) web.HandlerFunc {\r\n    return func(ctx *web.Context) {\r\n        defer func() {\r\n            if err := recover(); err != nil {\r\n                log.Printf("Panic recovered: %v", err)\r\n                debug.PrintStack()\r\n                \r\n                ctx.JSON(500, map[string]string{\r\n                    "error": "Internal server error",\r\n                })\r\n            }\r\n        }()\r\n        \r\n        next(ctx)\r\n    }\r\n}\n'})}),"\n",(0,i.jsx)(n.h4,{id:"3-\u8ba4\u8bc1\u4e2d\u95f4\u4ef6",children:"3. \u8ba4\u8bc1\u4e2d\u95f4\u4ef6"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'func AuthMiddleware(next web.HandlerFunc) web.HandlerFunc {\r\n    return func(ctx *web.Context) {\r\n        token := ctx.GetHeader("Authorization")\r\n        \r\n        // \u7b80\u5355\u7684 Bearer token \u68c0\u67e5\r\n        if !strings.HasPrefix(token, "Bearer ") {\r\n            ctx.JSON(401, map[string]string{"error": "Invalid authorization format"})\r\n            ctx.Abort()\r\n            return\r\n        }\r\n        \r\n        tokenString := strings.TrimPrefix(token, "Bearer ")\r\n        \r\n        user, err := validateToken(tokenString)\r\n        if err != nil {\r\n            ctx.JSON(401, map[string]string{"error": "Invalid token"})\r\n            ctx.Abort()\r\n            return\r\n        }\r\n        \r\n        // \u5c06\u7528\u6237\u4fe1\u606f\u5b58\u50a8\u5728\u4e0a\u4e0b\u6587\u4e2d\r\n        ctx.UserValues["user"] = user\r\n        ctx.UserValues["userID"] = user.ID\r\n        \r\n        next(ctx)\r\n    }\r\n}\r\n\r\nfunc validateToken(token string) (*User, error) {\r\n    // \u5b9e\u73b0 token \u9a8c\u8bc1\u903b\u8f91\r\n    // ...\r\n}\n'})}),"\n",(0,i.jsx)(n.h4,{id:"4-cors-\u4e2d\u95f4\u4ef6",children:"4. CORS \u4e2d\u95f4\u4ef6"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'func CORSMiddleware(next web.HandlerFunc) web.HandlerFunc {\r\n    return func(ctx *web.Context) {\r\n        ctx.SetHeader("Access-Control-Allow-Origin", "*")\r\n        ctx.SetHeader("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, OPTIONS")\r\n        ctx.SetHeader("Access-Control-Allow-Headers", \r\n            "Origin, Content-Type, Content-Length, Accept-Encoding, Authorization")\r\n        \r\n        // \u5904\u7406\u9884\u68c0\u8bf7\u6c42\r\n        if ctx.Req.Method == "OPTIONS" {\r\n            ctx.Status(204)\r\n            return\r\n        }\r\n        \r\n        next(ctx)\r\n    }\r\n}\n'})}),"\n",(0,i.jsx)(n.h4,{id:"5-\u8bf7\u6c42-id-\u4e2d\u95f4\u4ef6",children:"5. \u8bf7\u6c42 ID \u4e2d\u95f4\u4ef6"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'func RequestIDMiddleware(next web.HandlerFunc) web.HandlerFunc {\r\n    return func(ctx *web.Context) {\r\n        requestID := ctx.GetHeader("X-Request-ID")\r\n        \r\n        // \u5982\u679c\u8bf7\u6c42\u6ca1\u6709 ID\uff0c\u751f\u6210\u4e00\u4e2a\r\n        if requestID == "" {\r\n            requestID = uuid.New().String()\r\n        }\r\n        \r\n        // \u5c06\u8bf7\u6c42 ID \u6dfb\u52a0\u5230\u54cd\u5e94\u5934\r\n        ctx.SetHeader("X-Request-ID", requestID)\r\n        \r\n        // \u5b58\u50a8\u5728\u4e0a\u4e0b\u6587\u4e2d\u4f9b\u540e\u7eed\u4f7f\u7528\r\n        ctx.UserValues["requestID"] = requestID\r\n        \r\n        next(ctx)\r\n    }\r\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"\u5b8c\u6574\u793a\u4f8b",children:"\u5b8c\u6574\u793a\u4f8b"}),"\n",(0,i.jsx)(n.p,{children:"\u4ee5\u4e0b\u662f\u4e00\u4e2a\u7efc\u5408\u4f7f\u7528\u591a\u79cd\u4e2d\u95f4\u4ef6\u7684\u5b8c\u6574\u793a\u4f8b\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'package main\r\n\r\nimport (\r\n    "log"\r\n    "time"\r\n    \r\n    "github.com/fyerfyer/fyer-webframe/web"\r\n)\r\n\r\nfunc main() {\r\n    server := web.NewHTTPServer()\r\n    \r\n    // 1. \u5168\u5c40\u6062\u590d\u4e2d\u95f4\u4ef6\r\n    server.Middleware().Global().Add(func(next web.HandlerFunc) web.HandlerFunc {\r\n        return func(ctx *web.Context) {\r\n            defer func() {\r\n                if err := recover(); err != nil {\r\n                    log.Printf("Recovered from panic: %v", err)\r\n                    ctx.JSON(500, map[string]string{"error": "Internal server error"})\r\n                }\r\n            }()\r\n            next(ctx)\r\n        }\r\n    })\r\n    \r\n    // 2. \u8bf7\u6c42\u65e5\u5fd7\u4e2d\u95f4\u4ef6\r\n    server.Middleware().Global().Add(func(next web.HandlerFunc) web.HandlerFunc {\r\n        return func(ctx *web.Context) {\r\n            start := time.Now()\r\n            path := ctx.Req.URL.Path\r\n            method := ctx.Req.Method\r\n            \r\n            log.Printf("Request: %s %s", method, path)\r\n            next(ctx)\r\n            \r\n            duration := time.Since(start)\r\n            log.Printf("Response: %s %s %d %v", method, path, ctx.RespStatusCode, duration)\r\n        }\r\n    })\r\n    \r\n    // 3. API \u8def\u5f84\u7279\u5b9a\u7684\u4e2d\u95f4\u4ef6\r\n    apiMiddleware := func(next web.HandlerFunc) web.HandlerFunc {\r\n        return func(ctx *web.Context) {\r\n            log.Printf("API request received: %s", ctx.Req.URL.Path)\r\n            ctx.SetHeader("X-API-Version", "1.0")\r\n            next(ctx)\r\n        }\r\n    }\r\n    \r\n    // 4. \u8ba4\u8bc1\u4e2d\u95f4\u4ef6\r\n    authMiddleware := func(next web.HandlerFunc) web.HandlerFunc {\r\n        return func(ctx *web.Context) {\r\n            token := ctx.GetHeader("Authorization")\r\n            if token == "" {\r\n                ctx.JSON(401, map[string]string{"error": "Authentication required"})\r\n                ctx.Abort()\r\n                return\r\n            }\r\n            \r\n            // \u5728\u5b9e\u9645\u5e94\u7528\u4e2d\u9a8c\u8bc1token\r\n            ctx.UserValues["userID"] = 123\r\n            next(ctx)\r\n        }\r\n    }\r\n    \r\n    // 5. \u7ba1\u7406\u5458\u68c0\u67e5\u4e2d\u95f4\u4ef6\r\n    adminMiddleware := func(next web.HandlerFunc) web.HandlerFunc {\r\n        return func(ctx *web.Context) {\r\n            userID, ok := ctx.UserValues["userID"].(int)\r\n            if !ok || !isAdmin(userID) {\r\n                ctx.JSON(403, map[string]string{"error": "Admin access required"})\r\n                ctx.Abort()\r\n                return\r\n            }\r\n            next(ctx)\r\n        }\r\n    }\r\n    \r\n    // \u521b\u5efaAPI\u8def\u7531\u7ec4\u5e76\u5e94\u7528\u4e2d\u95f4\u4ef6\r\n    api := server.Group("/api").Use(apiMiddleware)\r\n    \r\n    // \u516c\u5f00API\u7aef\u70b9\r\n    api.Get("/public", func(ctx *web.Context) {\r\n        ctx.JSON(200, map[string]string{"message": "Public API"})\r\n    })\r\n    \r\n    // \u9700\u8981\u8ba4\u8bc1\u7684API\u7aef\u70b9\r\n    protected := api.Group("/protected").Use(authMiddleware)\r\n    protected.Get("/user", func(ctx *web.Context) {\r\n        userID := ctx.UserValues["userID"].(int)\r\n        ctx.JSON(200, map[string]interface{}{\r\n            "user_id": userID,\r\n            "message": "Protected user data",\r\n        })\r\n    })\r\n    \r\n    // \u9700\u8981\u7ba1\u7406\u5458\u6743\u9650\u7684API\u7aef\u70b9\r\n    admin := protected.Group("/admin").Use(adminMiddleware)\r\n    admin.Get("/dashboard", func(ctx *web.Context) {\r\n        ctx.JSON(200, map[string]string{"message": "Admin dashboard"})\r\n    })\r\n    \r\n    log.Println("Server starting on :8080")\r\n    server.Start(":8080")\r\n}\r\n\r\nfunc isAdmin(userID int) bool {\r\n    // \u5728\u5b9e\u9645\u5e94\u7528\u4e2d\u68c0\u67e5\u7528\u6237\u662f\u5426\u4e3a\u7ba1\u7406\u5458\r\n    admins := []int{123, 456}\r\n    for _, id := range admins {\r\n        if id == userID {\r\n            return true\r\n        }\r\n    }\r\n    return false\r\n}\n'})})]})}function u(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>s,x:()=>c});var t=r(6540);const i={},d=t.createContext(i);function s(e){const n=t.useContext(d);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),t.createElement(d.Provider,{value:n},e.children)}}}]);